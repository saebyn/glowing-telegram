name: Build and Push Docker Images, Deploy CDK

on:
  release:
    types: [published]


env:
  REGISTRY: 159222827421.dkr.ecr.us-west-2.amazonaws.com

jobs:
  # Phase 1: Deploy infrastructure dependencies
  # - FrontendStack: Creates S3 bucket needed by RepoStack
  # - RepoStack: Creates ECR repositories needed for Docker images
  # Production environment uses default stack names (no suffix)
  deploy-repo-dependencies:
    uses: ./.github/workflows/cdk-deploy-reusable.yml
    with:
      image_version: ${{ github.ref_name }}
      stacks: FrontendStack RepoStack
      environment: production
    permissions:
      contents: read
      id-token: write

  # Phase 2: Build and push Docker images to ECR
  # - Requires ECR repositories to exist (created in Phase 1)
  build-and-push:
    needs: deploy-repo-dependencies
    uses: ./.github/workflows/docker-build-reusable.yml
    with:
      build_batch1: true
      build_batch2: true
      push_images: true
      image_tag: ${{ github.ref_name }}
      aws_region: us-west-2
      registry: 159222827421.dkr.ecr.us-west-2.amazonaws.com
      aws_role_arn: arn:aws:iam::159222827421:role/GlowingTelegram-DockerGithubActionRole
    permissions:
      contents: read
      id-token: write

  # Phase 3: Deploy application stack and GitHub environment stack
  # - Requires Docker images to be available in ECR (created in Phase 2)
  # - GitHubEnvironmentStack synchronizes GitHub environment variables
  # Production environment uses default stack names (no suffix)
  deploy-app-stack:
    needs: build-and-push
    uses: ./.github/workflows/cdk-deploy-reusable.yml
    with:
      image_version: ${{ github.ref_name }}
      stacks: AppStack GitHubEnvironmentStack
      environment: production
    permissions:
      contents: read
      id-token: write