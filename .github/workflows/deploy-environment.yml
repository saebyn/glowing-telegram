name: Deploy to Environment

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to deploy from'
        required: true
        type: string
        default: 'main'
      image_tag:
        description: 'Docker image tag to use (leave empty to build from branch)'
        required: false
        type: string
      environment:
        description: 'Target environment to deploy to'
        required: true
        type: environment

env:
  REGISTRY: 159222827421.dkr.ecr.us-west-2.amazonaws.com

jobs:
  # Phase 1: Deploy infrastructure dependencies
  # - FrontendStack: Creates S3 bucket needed by RepoStack
  # - RepoStack: Creates ECR repositories needed for Docker images
  # This MUST happen before building Docker images
  deploy-repo-dependencies:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: Checkout specified branch
        uses: actions/checkout@v5
        with:
          ref: ${{ inputs.branch }}
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::159222827421:role/GlowingTelegram-DockerGithubActionRole
          aws-region: us-west-2
      
      - name: Setup Node.js for CDK
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: cdk/package-lock.json
      
      - name: Install CDK dependencies
        run: |
          cd cdk
          npm ci
      
      - name: Build CDK
        run: |
          cd cdk
          npm run build
      
      - name: Determine stack names based on environment
        id: stack_names
        run: |
          if [ "${{ inputs.environment }}" = "production" ]; then
            echo "frontend=FrontendStack" >> $GITHUB_OUTPUT
            echo "repo=RepoStack" >> $GITHUB_OUTPUT
          else
            echo "frontend=FrontendStack-${{ inputs.environment }}" >> $GITHUB_OUTPUT
            echo "repo=RepoStack-${{ inputs.environment }}" >> $GITHUB_OUTPUT
          fi
      
      - name: Deploy FrontendStack and RepoStack
        run: |
          cd cdk
          npm run cdk -- deploy ${{ steps.stack_names.outputs.frontend }} ${{ steps.stack_names.outputs.repo }} --require-approval never
        env:
          ENVIRONMENT: ${{ inputs.environment }}
          AWS_DEFAULT_REGION: us-west-2
          AWS_REGION: us-west-2

  # Phase 2: Build and push Docker images
  # - Requires ECR repositories to exist (created in Phase 1)
  # - Only runs if no image_tag is provided
  build-images:
    needs: deploy-repo-dependencies
    if: ${{ inputs.image_tag == '' }}
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: Checkout specified branch
        uses: actions/checkout@v5
        with:
          ref: ${{ inputs.branch }}
      
      - name: Generate image tag from branch and timestamp
        id: image_tag
        run: |
          # Sanitize branch name and validate it's not empty
          BRANCH_NAME=$(echo "${{ inputs.branch }}" | sed 's/[^a-zA-Z0-9-]/-/g' | sed 's/^-*//' | sed 's/-*$//')
          if [ -z "$BRANCH_NAME" ]; then
            echo "Error: Branch name sanitization resulted in empty string"
            echo "Original branch: ${{ inputs.branch }}"
            exit 1
          fi
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          IMAGE_TAG="${{ inputs.environment }}-${BRANCH_NAME}-${TIMESTAMP}"
          echo "tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "Generated image tag: ${IMAGE_TAG}"
          echo "Sanitized branch name: ${BRANCH_NAME}"
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::159222827421:role/GlowingTelegram-DockerGithubActionRole
          aws-region: us-west-2
      
      - name: Log in to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2
      
      - name: Free up space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          echo "Available storage:"
          sudo df -h
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build and push Docker images (Batch 1)
        uses: docker/bake-action@v5
        with:
          files: |
            ./docker-bake.hcl
            ./docker-bake.override.hcl
          targets: batch1
          push: true
          provenance: false
          set: |
            *.cache-from=type=gha
            *.cache-to=type=gha,mode=max
        env:
          IMAGE_TAG: ${{ steps.image_tag.outputs.tag }}
      
      - name: Build and push Docker images (Batch 2)
        uses: docker/bake-action@v5
        with:
          files: |
            ./docker-bake.hcl
            ./docker-bake.override.hcl
          targets: batch2
          push: true
          provenance: false
          set: |
            *.cache-from=type=gha
            *.cache-to=type=gha,mode=max
        env:
          IMAGE_TAG: ${{ steps.image_tag.outputs.tag }}
    
    outputs:
      image_tag: ${{ steps.image_tag.outputs.tag }}

  # Phase 3: Deploy application stack
  # - Requires Docker images to be available in ECR (created in Phase 2 or provided via input)
  deploy-app-stack:
    needs: [deploy-repo-dependencies, build-images]
    if: always() && needs.deploy-repo-dependencies.result == 'success' && (needs.build-images.result == 'success' || needs.build-images.result == 'skipped')
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: Checkout specified branch
        uses: actions/checkout@v5
        with:
          ref: ${{ inputs.branch }}
      
      - name: Determine image tag to use
        id: final_image_tag
        run: |
          if [ -n "${{ inputs.image_tag }}" ]; then
            echo "tag=${{ inputs.image_tag }}" >> $GITHUB_OUTPUT
            echo "Using provided image tag: ${{ inputs.image_tag }}"
          else
            echo "tag=${{ needs.build-images.outputs.image_tag }}" >> $GITHUB_OUTPUT
            echo "Using built image tag: ${{ needs.build-images.outputs.image_tag }}"
          fi
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::159222827421:role/GlowingTelegram-DockerGithubActionRole
          aws-region: us-west-2
      
      - name: Setup Node.js for CDK
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: cdk/package-lock.json
      
      - name: Install CDK dependencies
        run: |
          cd cdk
          npm ci
      
      - name: Build CDK
        run: |
          cd cdk
          npm run build
      
      - name: Determine stack names based on environment
        id: stack_names
        run: |
          if [ "${{ inputs.environment }}" = "production" ]; then
            echo "app=AppStack" >> $GITHUB_OUTPUT
            echo "github_env=GitHubEnvironmentStack" >> $GITHUB_OUTPUT
          else
            echo "app=AppStack-${{ inputs.environment }}" >> $GITHUB_OUTPUT
            echo "github_env=GitHubEnvironmentStack-${{ inputs.environment }}" >> $GITHUB_OUTPUT
          fi
      
      - name: Deploy AppStack and GitHubEnvironmentStack
        run: |
          cd cdk
          npm run cdk -- deploy ${{ steps.stack_names.outputs.app }} ${{ steps.stack_names.outputs.github_env }} --require-approval never
        env:
          ENVIRONMENT: ${{ inputs.environment }}
          IMAGE_VERSION: ${{ steps.final_image_tag.outputs.tag }}
          AWS_DEFAULT_REGION: us-west-2
          AWS_REGION: us-west-2
      
      - name: Display deployment summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ inputs.branch }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Tag**: ${{ steps.final_image_tag.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployment Order" >> $GITHUB_STEP_SUMMARY
          echo "1. ✅ FrontendStack and RepoStack (Phase 1)" >> $GITHUB_STEP_SUMMARY
          echo "2. ✅ Docker images built/pushed (Phase 2)" >> $GITHUB_STEP_SUMMARY
          echo "3. ✅ AppStack and GitHubEnvironmentStack deployed (Phase 3)" >> $GITHUB_STEP_SUMMARY
